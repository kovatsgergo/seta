<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=400, initial-scale=1.0">
    <title>Location-Based Sounds</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.rawgit.com/localForage/localForage/4ce19202/dist/localforage.min.js"></script>
    <script src="uniqueMe.js"></script>
    <!--script src="Tone.js"></script-->
    <script src="sound2.js"></script>
    <!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script-->
</head>

<body>
    <h1>CONTROL</h1>
    <div id="unique">unique id: </div>
    <button onclick="playItC(0, 'start')">start 1</button>
    <button onclick="playItC(0, 'stop')">pause 1</button>
    <button onclick="playItC(1, 'start')">start 2</button>
    <button onclick="playItC(1, 'stop')">pause 2</button>
    <button onclick="playItC(2, 'start')">start 3</button>
    <button onclick="playItC(2, 'stop')">pause 3</button>
    <button onclick="playItC(3, 'start')">start 4</button>
    <button onclick="playItC(3, 'stop')">pause 4</button>
    <h4>Itt láthatók az üzenetek a szervertől</h4>
    <div id="net">net messages</div>
    <h4>Zöldre vált ha letöltötte az adott fájlt</h4>
    <div class="row">
        <div class="block" id="bl0">1</div>
        <div class="block" id="bl1">2</div>
        <div class="block" id="bl2">3</div>
        <div class="block" id="bl3">4</div>
    </div>
    <h4>Jelenlegi pozíció</h4>
    <div id="demo"></div>
    <h4>Csatlakozott kliensek száma: <span id="nrclients"></span></h4>
    <!--div id="nrclients"></div-->
    <!--div id="mapid"></div-->
    <div id="watcher">watchxxxer</div>
    <div id="closeTo">close to</div>
    <audio id="myaudio" preload="auto" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <div id="progress">
        <div id="bar"></div>
    </div>
    <button class="full" id="start" onclick="startSound()">Hangok engedélyezése</button>
</body>

<script>
    var role = 'control';

    var HOST = location.origin.replace(/^http/, 'ws');

    var ws = new WebSocket(HOST);
    var uniqueId;

    ws.onopen = function (event) {
        uniqueId = getId(handShake)
        document.getElementById('net').innerHTML = 'websocket connection opened ';
    };

    ws.onmessage = function (event) {
        net.innerHTML = event.data;
        console.log(event.data);
        c = JSON.parse(event.data);
        if(c.clients){
            //console.log('clients ', c.clients);
            nrclients.innerHTML = c.clients;
        }
    }

    function playItC(ind, func) {
        message = {
            'control': {
                'ind': ind,
                'func': func
            }
        }
        ws.send(JSON.stringify(message));
        playIt(ind, func);
    }

    function handShake(id) {
        message = {
            'new': {
                'type': role,
                'id': id
            }
        }
        ws.send(JSON.stringify(message));
        unique.innerHTML += id;
    }

    function startSound() {
        //Tone.start();
        document.getElementById('start').remove();
        preparePlayer('0');
    }

    var x = document.getElementById("demo");
    var watcher = document.getElementById('watcher');
    var closeTo = document.getElementById('closeTo');
    var myAudio = document.getElementById('myaudio');
    var coords;

    var state = {
        'index': -1,
        'time': -1,
        'playing': false
    }

    /*var apiToken = 'pk.eyJ1Ijoia292YXRzZ2VyZ28iLCJhIjoiY2tua2N5b296MDJkODJwcXAzcTFhMmh1YiJ9.8lTFzDj7yi6NvfX4iNAo9Q'
    var mymap = L.map('mapid').setView([51.505, -0.09], 13);
    var marker;

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: apiToken
    }).addTo(mymap);*/


    //////////////////////////////////////////// AUDIO CONTROL
    myAudio.addEventListener('timeupdate', function () {
        //sets the percentage
        bar.style.width = parseInt(((myAudio.currentTime / myAudio.duration) * 100), 10) + "%";
        state.time = myAudio.currentTime;
        if (Math.floor(myAudio.currentTime) % 3 == 0) {
            ws.send(JSON.stringify(state));
        }
    });

    progress.addEventListener('click', function (e) {
        // calculate the normalized position clicked
        var clickPosition = (e.pageX - this.offsetLeft) / this.offsetWidth;
        var clickTime = clickPosition * myAudio.duration;

        // move the playhead to the correct position
        myAudio.currentTime = clickTime;
        ws.send(JSON.stringify({
            'timeupdate': myAudio.currentTime
        }));
    });



    /////////////////////////////////////// LOCATION
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            demo.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function showPosition(position) {
        demo.innerHTML = "Latitude: " + position.coords.latitude +
            "<br>Longitude: " + position.coords.longitude;
        /*p = [position.coords.latitude, position.coords.longitude];
        mymap.setView(p);
        marker = L.marker(p);
        marker.addTo(mymap);*/
    }

    getLocation();
</script>
<script src="geoloc.js"></script>