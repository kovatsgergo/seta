<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=400, initial-scale=1.0">
    <link rel="shortcut icon" type="image/png" href="/faviconCli.png" />
    <title>Idővnal néző</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.rawgit.com/localForage/localForage/4ce19202/dist/localforage.min.js"></script>
    <script src="uniqueMe.js"></script>
    <script src="NoSleep.js"></script>
</head>

<body>
    <h2>Néző</h2>
    <!--div id="mapid"></div-->
    <div id="unique">unique id: </div>
    <div>kiválasztott track: <span id="nowplaying"></span></div>
    <h4>Itt láthatók a parancsok a vezérlőtől</h4>
    <div id="net">net messages</div>
    <h4>Hangfájlok státusza</h4>
    <div class="row">
        <div class="block" id="bl0">1</div>
        <div class="block" id="bl1">2</div>
        <div class="block" id="bl2">3</div>
        <div class="block" id="bl3">4</div>
    </div>
    <audio id="myaudio" preload="auto" type="audio/x-m4a">
        Your browser does not support the audio element.
    </audio>
    <div id="progress">
        <div id="bar"></div>
        <span id="currTime"></span>
    </div>
    <div id="startButtons">
        <button class="full" id="start1" onclick="startClient(0)">1-es csoport</button>
        <button class="full" id="start2" onclick="startClient(1)">2-es csoport</button>
        <button class="full" id="start3" onclick="startClient(2)">3-as csoport</button>
    </div>
</body>

<script>
    var role = 'client';
    var group = -1;

    var x = document.getElementById("demo");
    var watcher = document.getElementById('watcher');
    var closeTo = document.getElementById('closeTo');
    var myAudio = document.getElementById('myaudio');
    var coords;
    var state = {
        'index': -1,
        'time': -1,
        'playing': false
    }

    ////////////////////////////////////////////// WebSocket
    var HOST = location.origin.replace(/^http/, 'ws');
    var ws;
    var uniqueId;

    function setCoords(coord) {
        temp = {
            'latitude': coord.latitude,
            'longitude': coord.longitude,
        }
        ws.send(JSON.stringify(temp));
    }

    ///////////////////////////////////////////// Geolocation, Sound

    function startClient(groupIndex) {

        ws = new WebSocket(HOST);
        ws.onopen = function (event) {
            group = groupIndex;
            uniqueId = getId(handShake)
            document.getElementById('net').innerHTML = 'websocket connection opened ';
            keepAlive();
        }

        ws.onmessage = function (event) {
            c = JSON.parse(event.data);
            if (c.time !== undefined) {
                //state = c;
                setupSoundState(c);
            }
            net.innerHTML = event.data;
        }

        ws.onclose = function (event) {
            cancelKeepAlive();
        }
        document.getElementById('startButtons').remove();
        if (!state.playing)
            preparePlayer('0');
        else {
            setupSoundState(state);
        }
        myAudio.play().then(_=>{
            myAudio.pause();
        });
        
        noSleep.enable();
    }

    function setupSoundState(c) {
        console.log(state, c);
        if (!c.playing) {
            doPlay('stop').then(_ => {
                if (c.time != state.time) {
                    myAudio.currentTime = Math.min(c.time, myAudio.duration);
                }
                state = c;
                nowplaying.innerHTML = '' + state.index + ' ' + state.playing;
                setBLs();
            });
        }
        if (state.index != c.index) {
            //console.log('THIS');
            preparePlayer(c.index).then(_ => {
                //console.log('PREPARED');
                setSpeed(c.time);
                if (c.playing) {
                    doPlay('start').then(_ => {
                        state = c;
                        nowplaying.innerHTML = '' + state.index + ' ' + state.playing;
                        setBLs();
                    });
                }
            });
        } else {
            if (c.time < myAudio.duration) {
                setSpeed(c.time);
                state.playing = c.playing;
                var command = c.playing ? 'start' : 'stop';
                doPlay(command).then(_ => {
                    nowplaying.innerHTML = '' + state.index + ' ' + state.playing;
                    setBLs();
                });
            }
        }
    }

    function setSpeed(time2) {
        var diff = time2 - state.time;
        console.log('diff ', diff);
        if (Math.abs(time2 - state.time) > 15) {
            myAudio.currentTime = time2;
            myAudio.playbackRate = 1;
        } else if (diff > 0) {
            myAudio.playbackRate = 1.25;
        } else if (diff < -2) {
            myAudio.playbackRate = 0.8;
        } else {
            myAudio.playbackRate = 1;
        }
    }

    myAudio.addEventListener('timeupdate', function () {
        //sets the percentage
        bar.style.width = parseInt(((myAudio.currentTime / myAudio.duration) * 100), 10) + "%";
        state.time = myAudio.currentTime;
        currTime.innerHTML = '' + myAudio.currentTime.toFixed(2) + '/' + myAudio.duration.toFixed(2);
    });

    myAudio.addEventListener("ended", function () {
        state.playing = false;
        //lastTime = myAudio.currentTime;
        setBoxColor(myAudio.index, true);
    });
</script>
<script src="sound2.js"></script>
<script src="common.js"></script>